name: Deploy All Files

on:
  push:
    branches:
      - main

permissions:
  contents: write  # Important: allow GITHUB_TOKEN to push

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Your build step (optional)
      - name: Install & Build
        run: |
          npm i
          npm run build
      - name: Add .htaccess to build folder
        run: |
          cat << 'EOF' > build/.htaccess
          # Disable directory listing
          Options -Indexes

          # Redirect all to index.html (SPA support)
          RewriteEngine On
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteRule ^ index.html [L]
          EOF

      # Ensure .git inside build is removed (if exists)
      # - name: Remove nested .git
      #   run: rm -rf build/.git

      # Create commit before pushing branch
      - name: Deploy entire repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout --orphan build
          git add .
          git commit -m "Initial build commit"
          git push --force origin build
